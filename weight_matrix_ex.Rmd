
```{r}
# Load required libraries
library(data.table)
library(mlr3)
library(mlr3resampling)

# Score benchmark results
score.dt <- bmr$score()
results <- as.data.table(score.dt)

# Initialize storage
weights_list <- list()
differences <- data.table()

# Process each unique taxa
for (taxa in unique(results$task_id)) {
  # Extract models for this taxa
  glmnet_results <- results[task_id == taxa & 
                           learner_id == "regr.cv_glmnet"]
  
  fuser_results <- results[task_id == taxa & 
                          learner_id == "regr.fuser"]
  
  if (nrow(glmnet_results) > 0 && nrow(fuser_results) > 0) {
    # Get the models
    glmnet_model <- glmnet_results$learner[[1]]$model
    fuser_model <- fuser_results$learner[[1]]$model
    
    if (!is.null(fuser_model) && !is.null(glmnet_model)) {
      # Extract weights
      fuser_w <- if (!is.null(fuser_model$model_type) && 
                     fuser_model$model_type == "fuser") fuser_model$beta else NULL
      glmnet_w <- coef(glmnet_model)
      
      if (!is.null(fuser_w) && !is.null(glmnet_w)) {
        # Process fuser weights if matrix
        if (is.matrix(fuser_w)) {
          fuser_w <- rowMeans(fuser_w)
        }
        
        # Convert sparse matrix to regular vector
        glmnet_w_dense <- as.vector(glmnet_w)
        names(glmnet_w_dense) <- rownames(glmnet_w)
        
        # Replace "." with 0 in glmnet weights
        glmnet_w_dense[glmnet_w_dense == "."] <- 0
        
        # Remove intercept and Group_ID
        glmnet_w_filtered <- glmnet_w_dense[!names(glmnet_w_dense) %in% 
                                            c("(Intercept)", "Group_ID")]
        
        # Convert to numeric explicitly
        glmnet_w_filtered <- as.numeric(glmnet_w_filtered)
        names(glmnet_w_filtered) <- names(glmnet_w_dense)[!names(glmnet_w_dense) %in% 
                                                           c("(Intercept)", "Group_ID")]
        
        # Get common features
        common_features <- intersect(names(fuser_w), names(glmnet_w_filtered))
        
        if (length(common_features) > 0) {
          # Subset both weight vectors to common features
          fuser_w_aligned <- fuser_w[common_features]
          glmnet_w_aligned <- glmnet_w_filtered[common_features]
          
          # Store weights
          weights_list[[taxa]] <- list(
            fuser = fuser_w_aligned,
            glmnet = glmnet_w_aligned,
            features = common_features
          )
          
          # Calculate differences
          weight_diff <- abs(fuser_w_aligned - glmnet_w_aligned)
          differences <- rbind(differences,
                             data.table(
                               taxa_id = taxa,
                               mean_diff = mean(weight_diff, na.rm = TRUE),
                               max_diff = max(weight_diff, na.rm = TRUE),
                               num_features = length(common_features),
                               nonzero_glmnet = sum(glmnet_w_aligned != 0),
                               nonzero_fuser = sum(fuser_w_aligned != 0)
                             ))
          
          # Print summary for each taxa
          cat("\nSummary for", taxa, ":\n")
          cat("Number of common features:", length(common_features), "\n")
          cat("Number of non-zero glmnet weights:", sum(glmnet_w_aligned != 0), "\n")
          cat("Number of non-zero fuser weights:", sum(fuser_w_aligned != 0), "\n")
          cat("Mean absolute difference:", mean(weight_diff, na.rm = TRUE), "\n")
          cat("Max absolute difference:", max(weight_diff, na.rm = TRUE), "\n\n")
          
          # Print top 5 features by absolute difference
          sorted_diff_idx <- order(weight_diff, decreasing = TRUE)[1:5]
          cat("Top 5 features with largest differences:\n")
          for (i in sorted_diff_idx) {
            cat(sprintf("%s: fuser=%.4f, glmnet=%.4f, diff=%.4f\n",
                       common_features[i],
                       fuser_w_aligned[i],
                       glmnet_w_aligned[i],
                       weight_diff[i]))
          }
          cat("\n")
        }
      }
    }
  }
}

# Save weights and differences
save(weights_list, differences, file = "model_weights.RData")

# Print overall summary
cat("\nOverall Summary:\n")
print(differences[order(-mean_diff)])
```